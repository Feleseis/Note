---
title: javascript异步
date: 2017-03-19 04:30:42
tags:
---

---
### 基本概念
单线程
> JS引擎中负责解释和执行JavaScript代码的线程只有一个
> 处理AJAX请求、处理DOM事件、定时器等为其他线程

同步和异步
> 同步——阻塞式调用，等待执行，能得到预期结果

```javascript
function add(...number) {
    let sum = 0;
    for (var i = 0; i < number.length; i++) {
        sum += number[i];
    }
    return sum;
}
console.log(add(1, 3, 5, 6));
```
> 异步—— 非阻塞，通知获取结果， 不能得到预期结果

```javascript
fs.readFile('a.txt', 'utf8', function(err, data) {
    console.log(data);
});
```
---
### 异步过程
> 主线程发起一个异步请求，相应的工作线程接收请求并告知主线程已收到(异步函数返回)；
> 主线程可以继续执行后面的代码，同时工作线程执行异步任务；
> 工作线程完成工作后，通知主线程；
> 主线程收到通知后，执行一定的动作(调用回调函数)。

```javascript
// 发起函数(或叫注册函数)A
// 回调函数callbackFn
// 注册函数用来发起异步过程，回调函数用来处理结果
A(args..., callbackFn)

//发起函数和回调函数可以是分离的
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = () => {}; // 添加回调函数
xhr.open('GET', url);
xhr.send(); // 发起函数
```
---
### 消息队列和事件循环
> 工作线程将消息放到消息队列，主线程通过事件循环过程去取消息。
> 消息队列：消息队列是一个先进先出的队列，它里面存放着各种消息。
> 事件循环：事件循环是指主线程重复从消息队列中取消息、执行的过程。
> 主线程只会做一件事情，就是从消息队列里面取消息、执行消息，再取消息、再执行。
> 当消息队列为空时，就会等待直到消息队列变成非空。而且主线程只有在将当前的消息执行完成后，才会去取下一个消息。
> 这种机制就叫做事件循环机制，取一个消息并执行的过程叫做一次循环。
> 异步过程的回调函数，一定不在当前这一轮事件循环中执行。

<pre>
        |-         执行其他代码              -|- 执行回调函数 -|
主线程=============================================================>
        |                                    |
        |                 |-     取出消息    -|
        |                 |   
    发起异步任务         消息1, 消息2, 消息3, 消息4 <== 消息队列
        |                                    |
        |           |-      存放消息         -|
        |           |
其他线程=============================================================>
        |- 执行异步 -|
</pre>
---
### 异步与事件
> 消息队列中的每条消息实际上都对应着一个事件
